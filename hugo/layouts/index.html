<!DOCTYPE html>
<html lang="en" class="h-full">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ .Site.Title }}</title>
    <!-- Import Tailwind via CDN for quick prototyping -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Customize Tailwind theme for dark mode and accent colors -->
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              background: '#0d0f12',
              surface: '#1a1d21',
              primary: '#6366f1',
              accent: '#34d399',
            },
          },
        },
      };
    </script>
  </head>
  <body class="h-full bg-background text-gray-200 min-h-screen">
    <header class="bg-primary text-white py-6 shadow">
      <div class="container mx-auto px-4 flex items-center justify-between">
        <h1 class="text-3xl font-bold tracking-wide">{{ .Site.Title }}</h1>
      </div>
    </header>
    <main class="container mx-auto px-4 py-8">
      <section class="mb-6">
        <h2 class="text-4xl font-extrabold mb-3">Discover Hidden Gems</h2>
        <p class="text-gray-400 max-w-2xl">
          Browse and celebrate lesser-known tools making a positive impact. Filter by source,
          search by name or description, and paginate through the collection.
        </p>
      </section>
      <!-- Search and filters -->
      <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4 mb-6">
        <div class="flex-1">
          <label for="searchInput" class="block text-sm font-medium text-gray-400 mb-1">Search</label>
          <input
            id="searchInput"
            type="text"
            placeholder="Search by name or description..."
            class="w-full bg-surface border border-gray-700 text-gray-200 rounded-lg px-3 py-2 focus:outline-none focus:ring focus:ring-primary"
          />
        </div>
        <div id="filterButtons" class="flex flex-wrap gap-2 md:mt-0"></div>
      </div>
      <!-- Tools grid -->
      <div id="toolsContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
      <!-- Pagination controls -->
      <div id="pagination" class="mt-8 flex justify-center gap-2"></div>
    </main>
    <footer class="text-center text-xs text-gray-500 py-6 border-t border-gray-800">
      &copy; <span id="year"></span> {{ .Site.Title }}. All rights reserved.
    </footer>
    <script>
      // Set current year in footer
      document.getElementById('year').textContent = new Date().getFullYear();

      const state = {
        allTools: [],
        filtered: [],
        search: '',
        sourceFilter: 'all',
        currentPage: 1,
        // Display 15 items per page (3 columns x 5 rows)
        itemsPerPage: 15,
      };

      async function loadTools() {
        try {
          // Adjust the API URL as needed when deploying; here we assume the API runs at the same host on port 8000
          const res = await fetch('https://jxsijx95au.eu-west-2.awsapprunner.com/tools');
          const data = await res.json();
          state.allTools = data;
          renderFilters();
          applyFilters();
        } catch (err) {
          console.error('Failed to fetch tools', err);
        }
      }

      function renderFilters() {
          const filterContainer = document.getElementById('filterButtons');
          filterContainer.innerHTML = '';
          // Determine unique sources
          const sources = new Set(state.allTools.map(t => t.reviews?.[0]?.source_kind).filter(Boolean));
          const createButton = (key, label) => {
            const btn = document.createElement('button');
            btn.textContent = label;
            btn.className = `px-3 py-1 rounded-full text-sm font-medium border transition ${state.sourceFilter === key ? 'bg-accent text-black' : 'bg-surface text-gray-300'} hover:bg-accent hover:text-black`;
            btn.addEventListener('click', () => {
              state.sourceFilter = key;
              state.currentPage = 1;
              // Re-render filters so the selected button gets highlighted
              renderFilters();
              applyFilters();
            });
            return btn;
          };
          // 'all' filter
          filterContainer.appendChild(createButton('all', 'All'));
          sources.forEach(src => {
            filterContainer.appendChild(createButton(src, src.replace(/_/g, ' ')));
          });
      }

      function applyFilters() {
        // Ensure filter buttons reflect current state
        renderFilters();
        const query = state.search.toLowerCase();
        state.filtered = state.allTools.filter(tool => {
          const matchesSource = state.sourceFilter === 'all' || (tool.reviews && tool.reviews[0] && tool.reviews[0].source_kind === state.sourceFilter);
          const text = `${tool.name} ${tool.description || ''}`.toLowerCase();
          const matchesSearch = !query || text.includes(query);
          return matchesSource && matchesSearch;
        });
        renderPage();
      }

      function renderPage() {
        const container = document.getElementById('toolsContainer');
        container.innerHTML = '';
        const start = (state.currentPage - 1) * state.itemsPerPage;
        const pageItems = state.filtered.slice(start, start + state.itemsPerPage);
        pageItems.forEach(tool => {
          const card = document.createElement('div');
          card.className = 'bg-surface rounded-xl p-5 flex flex-col shadow hover:shadow-lg transition';
          // Title becomes a clickable link to the tool's source (homepage, repo or review URL)
          const anchor = document.createElement('a');
          anchor.className = 'text-xl font-semibold text-accent mb-1 hover:underline';
          const link = tool.homepage || tool.repo_url || (tool.reviews && tool.reviews[0] && tool.reviews[0].source_url) || '#';
          anchor.href = link;
          anchor.target = '_blank';
          anchor.rel = 'noopener';
          anchor.textContent = tool.name;
          const desc = document.createElement('p');
          desc.className = 'text-gray-400 text-sm mb-2';
          desc.textContent = tool.description || 'No description available.';
          const tagContainer = document.createElement('div');
          tagContainer.className = 'flex flex-wrap gap-1 mb-2';
          if (tool.tags) {
            const tags = tool.tags.split(',');
            tags.forEach(tag => {
              const span = document.createElement('span');
              span.className = 'px-2 py-1 bg-gray-700 text-gray-300 text-xs rounded-full';
              span.textContent = tag.trim();
              tagContainer.appendChild(span);
            });
          }
          const source = document.createElement('p');
          source.className = 'text-gray-500 text-xs italic mb-2';
          // Determine human-friendly source label
          const srcKind = tool.reviews && tool.reviews[0] ? tool.reviews[0].source_kind : 'unknown';
          source.textContent = `Source: ${srcKind.replace(/_/g, ' ')}`;
          const snippet = document.createElement('p');
          snippet.className = 'text-gray-300 text-sm mt-auto';
          if (tool.reviews && tool.reviews.length > 0) {
            snippet.textContent = tool.reviews[0].snippet;
          }
          card.appendChild(anchor);
          card.appendChild(desc);
          card.appendChild(tagContainer);
          card.appendChild(source);
          card.appendChild(snippet);
          container.appendChild(card);
        });
        renderPagination();
      }

      function renderPagination() {
        const pagin = document.getElementById('pagination');
        pagin.innerHTML = '';
        const totalPages = Math.ceil(state.filtered.length / state.itemsPerPage) || 1;
        const createBtn = (label, disabled, onClick) => {
          const btn = document.createElement('button');
          btn.textContent = label;
          btn.disabled = disabled;
          btn.className = `px-3 py-1 rounded border border-gray-700 text-sm ${disabled ? 'text-gray-600' : 'hover:bg-primary hover:text-white'}`;
          if (!disabled) btn.addEventListener('click', onClick);
          return btn;
        };
        // Prev button
        pagin.appendChild(createBtn('Prev', state.currentPage === 1, () => {
          state.currentPage--;
          renderPage();
        }));
        // Page numbers: always show first and last page, and a sliding window of pages around the current page.
        const windowSize = 5;
        const windowHalf = Math.floor(windowSize / 2);
        let windowStart = Math.max(2, state.currentPage - windowHalf);
        let windowEnd = Math.min(totalPages - 1, state.currentPage + windowHalf);
        if (state.currentPage <= windowHalf + 1) {
          windowStart = 2;
          windowEnd = Math.min(totalPages - 1, windowSize);
        } else if (state.currentPage >= totalPages - windowHalf) {
          windowEnd = totalPages - 1;
          windowStart = Math.max(2, totalPages - windowSize + 1);
        }
        const addPageButton = (num) => {
          const btn = createBtn(num, false, () => {
            state.currentPage = num;
            renderPage();
          });
          if (num === state.currentPage) {
            btn.className += ' bg-primary text-white';
          }
          pagin.appendChild(btn);
        };
        addPageButton(1);
        if (windowStart > 2) {
          const ellipsis = document.createElement('span');
          ellipsis.textContent = '...';
          ellipsis.className = 'px-2 py-1 text-gray-500 select-none';
          pagin.appendChild(ellipsis);
        }
        for (let i = windowStart; i <= windowEnd; i++) {
          addPageButton(i);
        }
        if (windowEnd < totalPages - 1) {
          const ellipsis2 = document.createElement('span');
          ellipsis2.textContent = '...';
          ellipsis2.className = 'px-2 py-1 text-gray-500 select-none';
          pagin.appendChild(ellipsis2);
        }
        if (totalPages > 1) {
          addPageButton(totalPages);
        }
        pagin.appendChild(createBtn('Next', state.currentPage === totalPages, () => {
          state.currentPage++;
          renderPage();
        }));
      }

      // Search input handler
      document.getElementById('searchInput').addEventListener('input', (e) => {
        state.search = e.target.value;
        state.currentPage = 1;
        applyFilters();
      });

      // Kick off
      loadTools();
    </script>
  </body>
</html>
